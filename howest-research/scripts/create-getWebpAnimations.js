import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const CLUSTERS_DIR = path.join(__dirname, '../assets/images/clusters');
const OUTPUT_FILE = path.join(__dirname, 'getWebpAnimations.tsx');

console.log(`Scanning directory: ${CLUSTERS_DIR}`);

// Read files, ONLY files in the folder, no subfolders
const files = fs.readdirSync(CLUSTERS_DIR, { withFileTypes: true })
    .filter(dirent => !dirent.isDirectory() && dirent.name.endsWith('.webp'))
    .map(dirent => dirent.name)
    .sort();

console.log(`Found ${files.length} webp files.`);

// Group by cluster prefix
// Expect filenames like: prefix_intro.webp, prefix_loop.webp, prefix_outro.webp
const clusters = {};

files.forEach(file => {
    // Split by last underscore to separate suffix
    const lastUnderscoreIndex = file.lastIndexOf('_');
    if (lastUnderscoreIndex !== -1) {
        const prefix = file.substring(0, lastUnderscoreIndex);
        const suffixWithExt = file.substring(lastUnderscoreIndex + 1);
        const type = suffixWithExt.replace('.webp', ''); // intro, loop, outro

        if (!clusters[prefix]) {
            clusters[prefix] = {};
        }
        clusters[prefix][type] = file;
    }
});

let animationHooks = '';
let mapEntries = '';
const projectKeys = Object.keys(clusters).sort();

projectKeys.forEach(prefix => {
    // Generate hooks for intro, loop, outro
    ['intro', 'loop', 'outro'].forEach(type => {
        const fileName = clusters[prefix][type];
        if (fileName) {
            // Construct variable name: prefix + Type (capitalized)
            // e.g. prefix="activeHealthCah", type="intro" -> activeHealthCahIntro
            const varName = `${prefix}${type.charAt(0).toUpperCase() + type.slice(1)}`;

            // Generate const declaration
            animationHooks += `    const ${varName} = useAnimatedImage(require('../assets/images/clusters/${fileName}'));\n`;

            // Add to map
            mapEntries += `        '${varName}': ${varName},\n`;
        }
    });
    mapEntries += '\n'; // visual separation between clusters
});

// Generate projects array
const projectsArrayString = projectKeys.map(k => `'${k}'`).join(', ');

const fileContent = `// Auto-generated file. Do not edit manually.
// Generated by scripts/create-getWebpAnimations.js

import { useAnimatedImage } from '@shopify/react-native-skia';

export const useWebpAnimations = () => {
${animationHooks}
    // Define a strict map to lookup animations by constructed key
    const animationMap: Record<string, ReturnType<typeof useAnimatedImage>> = {
${mapEntries}    };

    const projects = [${projectsArrayString}];

    return { animationMap, projects };
};
`;

// Write to file
fs.writeFileSync(OUTPUT_FILE, fileContent, 'utf8');
console.log(`‚úÖ Generated getWebpAnimations.tsx with ${projectKeys.length} clusters`);
console.log(`üìÅ Clusters identified: ${projectKeys.join(', ')}`);